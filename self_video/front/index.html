<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Skills - çŸ­è§†é¢‘åˆ›ä½œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans SC', sans-serif; }
        code, .code { font-family: 'Fira Code', monospace; }

        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%); }
        .gradient-accent { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); }

        .skill-card { transition: all 0.3s ease; }
        .skill-card:hover { transform: translateY(-2px); }
        .skill-card.active { border-color: #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .skill-card.completed { border-color: #10b981; }

        .typing-cursor::after {
            content: 'â–Š';
            animation: blink 0.8s infinite;
            color: #3b82f6;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .log-entry { animation: slideIn 0.2s ease; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .stream-text { white-space: pre-wrap; line-height: 1.8; }

        .pulse-dot {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .copy-btn {
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            transform: scale(1.05);
        }
        .copy-btn.copied {
            background: #10b981 !important;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <!-- Header -->
    <header class="gradient-bg border-b border-slate-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 gradient-accent rounded-lg flex items-center justify-center">
                        <span class="text-xl">ğŸ¤–</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Agent Skills System</h1>
                        <p class="text-slate-400 text-xs">Python FastAPI åç«¯ + SSE æµå¼è¾“å‡º</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="backendStatus" class="px-3 py-1.5 bg-slate-700 rounded-lg text-sm">
                        <span class="inline-block w-2 h-2 bg-yellow-400 rounded-full mr-2"></span>
                        æ£€æµ‹ä¸­...
                    </span>
                    <button onclick="toggleConfig()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">
                        âš™ï¸ APIé…ç½®
                    </button>
                    <button onclick="testConnection()" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition">
                        ğŸ”— æµ‹è¯•è¿æ¥
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg border border-slate-700">
            <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                <h3 class="text-lg font-bold">âš™ï¸ åç«¯ & API é…ç½®</h3>
                <button onclick="toggleConfig()" class="text-slate-400 hover:text-white text-xl">Ã—</button>
            </div>
            <div class="p-4 space-y-4">
                <!-- åç«¯åœ°å€ -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">åç«¯æœåŠ¡åœ°å€</label>
                    <input type="text" id="backendUrl" value="http://localhost:8001"
                        class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500 code">
                    <p class="text-xs text-slate-500 mt-1">FastAPI æœåŠ¡åœ°å€ï¼Œé»˜è®¤ http://localhost:8001</p>
                </div>

                <hr class="border-slate-700">

                <!-- LLM é…ç½® -->
                <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡å‹æä¾›å•†</label>
                    <select id="providerSelect" onchange="updateProviderDefaults()" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="openai">OpenAI</option>
                        <option value="zhipu">æ™ºè°±AI (GLM)</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="moonshot">Moonshot (Kimi)</option>
                        <option value="qwen">é€šä¹‰åƒé—®</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">API Base URL</label>
                    <input type="text" id="apiBaseUrl" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500 code">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">API Key</label>
                    <input type="password" id="apiKey" placeholder="sk-..." class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500 code">
                </div>
                <div>
                    <label class="block text-sm text-slate-400 mb-1">æ¨¡å‹åç§°</label>
                    <input type="text" id="modelName" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500 code">
                </div>

                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-xs text-blue-300">
                    ğŸ’¡ APIé…ç½®ä¼šéšè¯·æ±‚å‘é€åˆ°åç«¯ï¼Œä¹Ÿå¯ä»¥åœ¨åç«¯ .env æ–‡ä»¶ä¸­é¢„é…ç½®
                </div>
            </div>
            <div class="p-4 border-t border-slate-700 flex justify-between">
                <button onclick="validateConfig()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition">
                    ğŸ” éªŒè¯é…ç½®
                </button>
                <div class="flex gap-2">
                    <button onclick="toggleConfig()" class="px-4 py-2 text-slate-400 hover:text-white transition">å–æ¶ˆ</button>
                    <button onclick="saveConfig()" class="px-4 py-2 gradient-accent rounded-lg font-medium hover:opacity-90 transition">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Input Section -->
        <div class="bg-slate-800 rounded-xl border border-slate-700 p-4 mb-6">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <label class="block text-sm text-slate-400 mb-2">ğŸ“ è¾“å…¥è„šæœ¬ä¸»é¢˜</label>
                    <input type="text" id="topicInput"
                        placeholder="ä¾‹å¦‚ï¼šå››æ¸¡èµ¤æ°´å…¨è¿‡ç¨‹"
                        value="å››æ¸¡èµ¤æ°´å…¨è¿‡ç¨‹"
                        class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:border-blue-500 text-lg">
                </div>
                <div class="flex gap-2 pt-6">
                    <button id="startBtn" onclick="startWorkflow()"
                        class="px-6 py-3 gradient-accent rounded-lg font-medium hover:opacity-90 transition flex items-center gap-2 disabled:opacity-50">
                        <span>â–¶</span> æ‰§è¡Œå·¥ä½œæµ
                    </button>
                    <button onclick="resetWorkflow()"
                        class="px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg transition">
                        â†º é‡ç½®
                    </button>
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Skills Panel -->
            <div class="lg:col-span-2 space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="font-semibold text-slate-300">ğŸ”— Skill æ‰§è¡Œé“¾ (åç«¯é©±åŠ¨)</h2>
                    <span id="progressText" class="text-sm text-slate-500">0 / 6</span>
                </div>

                <div id="skillsContainer" class="space-y-3">
                    <!-- Skills will be rendered here -->
                    <div class="text-center text-slate-500 py-8">
                        <div class="animate-spin w-8 h-8 border-2 border-slate-600 border-t-blue-500 rounded-full mx-auto mb-3"></div>
                        æ­£åœ¨ä»åç«¯åŠ è½½ Skills...
                    </div>
                </div>
            </div>

            <!-- Log Panel -->
            <div class="lg:col-span-1">
                <h2 class="font-semibold text-slate-300 mb-2">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</h2>
                <div class="bg-slate-950 rounded-xl border border-slate-700 h-[600px] overflow-hidden flex flex-col">
                    <div class="px-3 py-2 border-b border-slate-800 flex items-center gap-2">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                        <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                        <span class="text-xs text-slate-500 ml-2">console â†’ backend</span>
                    </div>
                    <div id="logContainer" class="flex-1 overflow-y-auto p-3 code text-xs space-y-1">
                        <div class="text-slate-500">// Connecting to Python Backend...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ============================================== -->
    <!-- API Client - åç«¯æ¥å£è°ƒç”¨                       -->
    <!-- ============================================== -->
    <script>
    /**
     * ========================================
     * å‰ç«¯ API å®¢æˆ·ç«¯
     * è´Ÿè´£ä¸ Python FastAPI åç«¯é€šä¿¡
     * ========================================
     */

    // ============ é…ç½®ç®¡ç† ============
    const ConfigManager = {
        defaultConfig: {
            backendUrl: 'http://localhost:8001',
            provider: 'openai',
            baseUrl: 'https://api.openai.com/v1',
            apiKey: '',
            model: 'gpt-4o-mini'
        },

        load() {
            try {
                const saved = localStorage.getItem('agent_skills_config_v2');
                return saved ? { ...this.defaultConfig, ...JSON.parse(saved) } : { ...this.defaultConfig };
            } catch (e) {
                return { ...this.defaultConfig };
            }
        },

        save(config) {
            const merged = { ...this.load(), ...config };
            localStorage.setItem('agent_skills_config_v2', JSON.stringify(merged));
            return merged;
        },

        get() {
            return this.load();
        },

        isConfigured() {
            const config = this.load();
            return Boolean(config.apiKey && config.backendUrl);
        }
    };

    // ============ API å®¢æˆ·ç«¯ ============
    const ApiClient = {
        getBaseUrl() {
            return ConfigManager.get().backendUrl;
        },

        // è·å–å¥åº·çŠ¶æ€
        async healthCheck() {
            const response = await fetch(`${this.getBaseUrl()}/api/self_video/health`);
            if (!response.ok) throw new Error('Backend not available');
            return response.json();
        },

        // è·å–æ‰€æœ‰ Skills
        async getSkills() {
            const response = await fetch(`${this.getBaseUrl()}/api/self_video/skills`);
            if (!response.ok) throw new Error('Failed to fetch skills');
            return response.json();
        },

        // éªŒè¯ LLM é…ç½®
        async validateConfig(config) {
            const response = await fetch(`${this.getBaseUrl()}/api/self_video/config/validate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: config.provider,
                    base_url: config.baseUrl,
                    api_key: config.apiKey,
                    model: config.model
                })
            });
            return response.json();
        },

        // è¿è¡Œå·¥ä½œæµ (SSE æµå¼)
        async runWorkflow(topic, onEvent) {
            const config = ConfigManager.get();

            const response = await fetch(`${this.getBaseUrl()}/api/self_video/workflow/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    topic: topic,
                    config: {
                        provider: config.provider,
                        base_url: config.baseUrl,
                        api_key: config.apiKey,
                        model: config.model
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Workflow failed');
            }

            // å¤„ç† SSE æµ
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n').filter(line => line.startsWith('data:'));

                for (const line of lines) {
                    const data = line.slice(5).trim();
                    if (data === '[DONE]') {
                        onEvent({ event: 'done' });
                        continue;
                    }

                    try {
                        const event = JSON.parse(data);
                        onEvent(event);
                    } catch (e) {
                        // Skip parse errors
                    }
                }
            }
        }
    };

    // ============ UI æ§åˆ¶å™¨ ============
    const UIController = {
        skills: [],
        skillMap: {},
        skillOutputs: {},  // å­˜å‚¨æ¯ä¸ªskillçš„åŸå§‹è¾“å‡ºå†…å®¹

        addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const log = document.createElement('div');
            log.className = 'log-entry';

            const time = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                system: 'text-purple-400',
                http: 'text-cyan-400'
            };

            log.innerHTML = `<span class="text-slate-600">[${time}]</span> <span class="${colors[type] || colors.info}">${message}</span>`;
            container.appendChild(log);
            container.scrollTop = container.scrollHeight;
        },

        updateBackendStatus(status, text) {
            const badge = document.getElementById('backendStatus');
            const colors = {
                online: 'bg-green-400',
                offline: 'bg-red-400',
                checking: 'bg-yellow-400 pulse-dot'
            };
            badge.innerHTML = `<span class="inline-block w-2 h-2 ${colors[status]} rounded-full mr-2"></span>${text}`;
        },

        renderSkills(skills, workflowOrder) {
            this.skills = skills;
            this.skillMap = {};
            skills.forEach(s => this.skillMap[s.id] = s);

            const container = document.getElementById('skillsContainer');
            const orderedSkills = workflowOrder.map(id => skills.find(s => s.id === id)).filter(Boolean);

            container.innerHTML = orderedSkills.map((skill, index) => `
                <div id="skill-${skill.id}" class="skill-card bg-slate-800 rounded-xl border-2 border-slate-700 overflow-hidden">
                    <div class="p-4 flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-xl flex-shrink-0" id="icon-${skill.id}">
                            ${skill.icon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs text-slate-500">SKILL ${index + 1}</span>
                                <span id="status-${skill.id}" class="px-2 py-0.5 bg-slate-700 text-slate-400 text-xs rounded">å¾…æ‰§è¡Œ</span>
                            </div>
                            <h3 class="font-semibold">${skill.name}</h3>
                            <p class="text-sm text-slate-400">${skill.description}</p>
                        </div>
                    </div>
                    <div id="output-${skill.id}" class="hidden border-t border-slate-700 bg-slate-900/50">
                        <div class="flex items-center justify-between px-4 py-2 bg-slate-800/50 border-b border-slate-700">
                            <span class="text-xs text-slate-500">è¾“å‡ºç»“æœ</span>
                            <button id="copy-btn-${skill.id}" onclick="copySkillOutput('${skill.id}')"
                                class="copy-btn px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs flex items-center gap-1.5 transition">
                                <span class="copy-icon">ğŸ“‹</span>
                                <span class="copy-text">å¤åˆ¶</span>
                            </button>
                        </div>
                        <div class="p-4 max-h-96 overflow-y-auto">
                            <div class="stream-text text-sm text-slate-300"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        },

        onSkillStart(skillId) {
            const skill = this.skillMap[skillId];
            if (!skill) return;

            this.addLog(`â–¶ å¼€å§‹æ‰§è¡Œ: ${skill.name}`, 'system');

            const card = document.getElementById(`skill-${skillId}`);
            const status = document.getElementById(`status-${skillId}`);
            const output = document.getElementById(`output-${skillId}`);
            const icon = document.getElementById(`icon-${skillId}`);

            if (card) card.classList.add('active');
            if (status) {
                status.textContent = 'æ‰§è¡Œä¸­...';
                status.className = 'px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded';
            }
            if (output) {
                output.classList.remove('hidden');
                output.querySelector('.stream-text').innerHTML = '<span class="typing-cursor"></span>';
            }
            if (icon) {
                icon.innerHTML = '<div class="w-5 h-5 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div>';
            }
        },

        onSkillStream(skillId, content) {
            const output = document.getElementById(`output-${skillId}`);
            if (output) {
                this.skillOutputs[skillId] = content;  // å­˜å‚¨åŸå§‹å†…å®¹
                const streamTextEl = output.querySelector('.stream-text');
                streamTextEl.innerHTML = this.formatText(content) + '<span class="typing-cursor"></span>';
                // æ»šåŠ¨åˆ°åº•éƒ¨
                const scrollContainer = streamTextEl.parentElement;
                scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }
        },

        onSkillComplete(skillId, content) {
            const skill = this.skillMap[skillId];
            if (!skill) return;

            this.addLog(`âœ“ å®Œæˆ: ${skill.name}`, 'success');

            // å­˜å‚¨åŸå§‹å†…å®¹ç”¨äºå¤åˆ¶
            this.skillOutputs[skillId] = content;

            const card = document.getElementById(`skill-${skillId}`);
            const status = document.getElementById(`status-${skillId}`);
            const output = document.getElementById(`output-${skillId}`);
            const icon = document.getElementById(`icon-${skillId}`);

            if (card) {
                card.classList.remove('active');
                card.classList.add('completed');
            }
            if (status) {
                status.textContent = 'å·²å®Œæˆ';
                status.className = 'px-2 py-0.5 bg-green-500/20 text-green-400 text-xs rounded';
            }
            if (output) {
                output.querySelector('.stream-text').innerHTML = this.formatText(content);
            }
            if (icon) {
                icon.innerHTML = skill.icon;
            }
        },

        onSkillError(skillId, error) {
            this.addLog(`âœ— é”™è¯¯: ${error}`, 'error');

            const card = document.getElementById(`skill-${skillId}`);
            const status = document.getElementById(`status-${skillId}`);
            const icon = document.getElementById(`icon-${skillId}`);
            const skill = this.skillMap[skillId];

            if (card) card.classList.remove('active');
            if (status) {
                status.textContent = 'å¤±è´¥';
                status.className = 'px-2 py-0.5 bg-red-500/20 text-red-400 text-xs rounded';
            }
            if (icon && skill) {
                icon.innerHTML = skill.icon;
            }
        },

        updateProgress(current, total) {
            document.getElementById('progressText').textContent = `${current} / ${total}`;
        },

        formatText(text) {
            if (!text) return '';
            return text
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/^### (.*$)/gm, '<strong class="text-blue-400">$1</strong>')
                .replace(/^## (.*$)/gm, '<strong class="text-purple-400 text-lg">$1</strong>')
                .replace(/^# (.*$)/gm, '<strong class="text-pink-400 text-xl">$1</strong>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        },

        setLoading(loading) {
            const btn = document.getElementById('startBtn');
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin">â—Œ</span> æ‰§è¡Œä¸­...';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<span>â–¶</span> æ‰§è¡Œå·¥ä½œæµ';
            }
        }
    };

    // ============ ä¸»æ§åˆ¶å™¨ ============
    const App = {
        completedSkills: 0,
        totalSkills: 5,

        async init() {
            UIController.addLog('åˆå§‹åŒ–å‰ç«¯åº”ç”¨...', 'system');
            this.loadConfigToForm();
            await this.checkBackend();
        },

        async checkBackend() {
            UIController.updateBackendStatus('checking', 'æ£€æµ‹ä¸­...');
            UIController.addLog(`GET ${ConfigManager.get().backendUrl}/api/self_video/health`, 'http');

            try {
                const health = await ApiClient.healthCheck();
                UIController.updateBackendStatus('online', 'åç«¯åœ¨çº¿');
                UIController.addLog(`åç«¯çŠ¶æ€: ${JSON.stringify(health)}`, 'success');

                // åŠ è½½ Skills
                await this.loadSkills();
            } catch (error) {
                UIController.updateBackendStatus('offline', 'åç«¯ç¦»çº¿');
                UIController.addLog(`åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                UIController.addLog('è¯·ç¡®ä¿ Python åç«¯å·²å¯åŠ¨: python -m backend.main', 'warning');
            }
        },

        async loadSkills() {
            UIController.addLog(`GET ${ConfigManager.get().backendUrl}/api/self_video/skills`, 'http');

            try {
                const data = await ApiClient.getSkills();
                UIController.addLog(`åŠ è½½äº† ${data.skills.length} ä¸ª Skills`, 'success');
                UIController.renderSkills(data.skills, data.workflow_order);
                this.totalSkills = data.skills.length;
            } catch (error) {
                UIController.addLog(`åŠ è½½ Skills å¤±è´¥: ${error.message}`, 'error');
            }
        },

        loadConfigToForm() {
            const config = ConfigManager.get();
            document.getElementById('backendUrl').value = config.backendUrl || 'http://localhost:8001';
            document.getElementById('providerSelect').value = config.provider || 'openai';
            document.getElementById('apiBaseUrl').value = config.baseUrl || '';
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('modelName').value = config.model || '';
        }
    };

    // ============ å…¨å±€å‡½æ•° ============
    const providerDefaults = {
        openai: { url: 'https://api.openai.com/v1', model: 'gpt-4o-mini' },
        zhipu: { url: 'https://open.bigmodel.cn/api/self_video/paas/v4', model: 'glm-4-flash' },
        deepseek: { url: 'https://api.deepseek.com/v1', model: 'deepseek-chat' },
        moonshot: { url: 'https://api.moonshot.cn/v1', model: 'moonshot-v1-8k' },
        qwen: { url: 'https://dashscope.aliyuncs.com/compatible-mode/v1', model: 'qwen-turbo' },
        custom: { url: '', model: '' }
    };

    function toggleConfig() {
        document.getElementById('configModal').classList.toggle('hidden');
        App.loadConfigToForm();
    }

    function updateProviderDefaults() {
        const provider = document.getElementById('providerSelect').value;
        const defaults = providerDefaults[provider];
        document.getElementById('apiBaseUrl').value = defaults.url;
        document.getElementById('modelName').value = defaults.model;
    }

    function saveConfig() {
        const config = {
            backendUrl: document.getElementById('backendUrl').value.replace(/\/$/, ''),
            provider: document.getElementById('providerSelect').value,
            baseUrl: document.getElementById('apiBaseUrl').value,
            apiKey: document.getElementById('apiKey').value,
            model: document.getElementById('modelName').value
        };
        ConfigManager.save(config);
        toggleConfig();
        UIController.addLog(`é…ç½®å·²ä¿å­˜: ${config.provider}/${config.model}`, 'success');
        App.checkBackend();
    }

    async function validateConfig() {
        const config = {
            provider: document.getElementById('providerSelect').value,
            baseUrl: document.getElementById('apiBaseUrl').value,
            apiKey: document.getElementById('apiKey').value,
            model: document.getElementById('modelName').value
        };

        UIController.addLog('POST /api/self_video/config/validate', 'http');

        try {
            const result = await ApiClient.validateConfig(config);
            if (result.valid) {
                UIController.addLog(`âœ“ é…ç½®éªŒè¯æˆåŠŸ: ${result.message}`, 'success');
                alert('âœ… é…ç½®éªŒè¯æˆåŠŸï¼');
            } else {
                UIController.addLog(`âœ— é…ç½®éªŒè¯å¤±è´¥: ${result.message}`, 'error');
                alert('âŒ é…ç½®éªŒè¯å¤±è´¥: ' + result.message);
            }
        } catch (error) {
            UIController.addLog(`éªŒè¯è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            alert('è¯·æ±‚å¤±è´¥: ' + error.message);
        }
    }

    async function testConnection() {
        await App.checkBackend();
    }

    async function startWorkflow() {
        const topic = document.getElementById('topicInput').value.trim();
        if (!topic) {
            alert('è¯·è¾“å…¥è„šæœ¬ä¸»é¢˜');
            return;
        }

        const config = ConfigManager.get();
        if (!config.apiKey) {
            alert('è¯·å…ˆé…ç½® API Key');
            toggleConfig();
            return;
        }

        UIController.setLoading(true);
        UIController.addLog('â”â”â” å¼€å§‹æ‰§è¡Œå·¥ä½œæµ â”â”â”', 'system');
        UIController.addLog(`ä¸»é¢˜: ${topic}`, 'info');
        UIController.addLog(`POST ${config.backendUrl}/api/self_video/workflow/run`, 'http');

        App.completedSkills = 0;

        try {
            await ApiClient.runWorkflow(topic, (event) => {
                // å¤„ç†åç«¯ SSE äº‹ä»¶
                switch (event.event) {
                    case 'workflow:start':
                        UIController.addLog(`å·¥ä½œæµå¯åŠ¨: ${event.data?.topic}`, 'system');
                        break;

                    case 'skill:start':
                        UIController.onSkillStart(event.skill_id);
                        break;

                    case 'skill:stream':
                        UIController.onSkillStream(event.skill_id, event.data?.content);
                        break;

                    case 'skill:complete':
                        UIController.onSkillComplete(event.skill_id, event.data?.content);
                        App.completedSkills++;
                        UIController.updateProgress(App.completedSkills, App.totalSkills);
                        break;

                    case 'skill:error':
                        UIController.onSkillError(event.skill_id, event.data?.error);
                        break;

                    case 'workflow:complete':
                        UIController.addLog('â”â”â” å·¥ä½œæµæ‰§è¡Œå®Œæˆ â”â”â”', 'success');
                        UIController.setLoading(false);
                        break;

                    case 'workflow:error':
                        UIController.addLog(`å·¥ä½œæµé”™è¯¯: ${event.data?.error}`, 'error');
                        UIController.setLoading(false);
                        break;

                    case 'error':
                        UIController.addLog(`é”™è¯¯: ${event.data?.error}`, 'error');
                        UIController.setLoading(false);
                        break;

                    case 'done':
                        UIController.addLog('SSE æµç»“æŸ', 'info');
                        UIController.setLoading(false);
                        break;
                }
            });
        } catch (error) {
            UIController.addLog(`å·¥ä½œæµå¤±è´¥: ${error.message}`, 'error');
            UIController.setLoading(false);
        }
    }

    function resetWorkflow() {
        // é‡æ–°åŠ è½½ Skills
        App.loadSkills();
        App.completedSkills = 0;
        UIController.skillOutputs = {};  // æ¸…ç©ºå­˜å‚¨çš„è¾“å‡º
        UIController.updateProgress(0, App.totalSkills);
        document.getElementById('logContainer').innerHTML = '<div class="text-slate-500">// ç³»ç»Ÿå·²é‡ç½®ï¼Œç­‰å¾…æ‰§è¡Œ...</div>';
        UIController.addLog('å·¥ä½œæµå·²é‡ç½®', 'warning');
    }

    // å¤åˆ¶Skillè¾“å‡ºå†…å®¹
    async function copySkillOutput(skillId) {
        const content = UIController.skillOutputs[skillId];
        if (!content) {
            UIController.addLog(`å¤åˆ¶å¤±è´¥: ${skillId} æš‚æ— å†…å®¹`, 'warning');
            return;
        }

        const btn = document.getElementById(`copy-btn-${skillId}`);

        try {
            await navigator.clipboard.writeText(content);

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (btn) {
                btn.classList.add('copied');
                btn.querySelector('.copy-icon').textContent = 'âœ…';
                btn.querySelector('.copy-text').textContent = 'å·²å¤åˆ¶';

                // 2ç§’åæ¢å¤
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.querySelector('.copy-icon').textContent = 'ğŸ“‹';
                    btn.querySelector('.copy-text').textContent = 'å¤åˆ¶';
                }, 2000);
            }

            const skill = UIController.skillMap[skillId];
            UIController.addLog(`ğŸ“‹ å·²å¤åˆ¶: ${skill?.name || skillId} (${content.length} å­—ç¬¦)`, 'success');

        } catch (error) {
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ textarea
            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                if (btn) {
                    btn.classList.add('copied');
                    btn.querySelector('.copy-icon').textContent = 'âœ…';
                    btn.querySelector('.copy-text').textContent = 'å·²å¤åˆ¶';

                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btn.querySelector('.copy-icon').textContent = 'ğŸ“‹';
                        btn.querySelector('.copy-text').textContent = 'å¤åˆ¶';
                    }, 2000);
                }
                const skill = UIController.skillMap[skillId];
                UIController.addLog(`ğŸ“‹ å·²å¤åˆ¶: ${skill?.name || skillId} (${content.length} å­—ç¬¦)`, 'success');
            } catch (e) {
                UIController.addLog(`å¤åˆ¶å¤±è´¥: ${e.message}`, 'error');
            }

            document.body.removeChild(textarea);
        }
    }

    // ============ å¯åŠ¨ ============
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
    </script>
</body>
</html>
